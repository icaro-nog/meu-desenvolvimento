var CustomizeBuilder_V2;!function(o){var d=o(document),r=wp.customize||null,t=Customify_Layout_Builder.is_rtl;CustomizeBuilder_V2=function(c,s){var e={id:s,version:"v2",controlId:"",items:[],container:null,ready:!1,devices:{desktop:"Desktop",mobile:"Mobile/Tablet"},activePanel:"desktop",panels:{},activeRow:"main",draggingItem:null,getTemplate:_.memoize(function(){var n=this,a={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(e,i,t){return _.isUndefined(i)&&(i="tmpl-customize-control-"+n.type),!_.isUndefined(t)&&_.isString(t)?a.variable=t:a.variable="data",_.template(o("#"+i).html(),null,a)(e)}}),drag_drop:function(){var a=this;o(".customify--device-panel",a.container).each(function(){var e=o(this),t=e.data("device"),n=[],e=(o(".col-items",e).each(function(e){var i=o(this).attr("data-id")||"",i=i?"_sid_"+t+"-"+i:"_sid_"+t+e;o(this).attr("id",i),n[e]="#"+i}),o(".col-items, .customify-available-items",e).each(function(){o(this).droppable().sortable({placeholder:"sortable-placeholder grid-stack-item",connectWith:".col-items",update:function(){a.save()}})}),o("#_sid_mobile-sidebar",e));e.attr("id");0<e.length&&e.sortable({revert:!0,change:function(e,i){a.save()}})})},addPanel:function(e){var i=this.getTemplate(),t="tmpl-customify--cb-panel-v2";if(0!=o("#"+t).length)return _.isObject(c.rows)||(c.rows={}),'<div class="customify--device-panel customify-vertical-panel customify--panel-'+e+'" data-device="'+e+'">'+i({device:e,id:c.id,rows:c.rows},t)+"</div>"},addDevicePanels:function(){var n=this;_.each(n.devices,function(e,i){var t=n.addPanel(i);o(".customify--cb-devices-switcher",n.container).append('<a href="#" class="switch-to switch-to-'+i+'" data-device="'+i+'">'+e+"</a>"),o(".customify--cb-body",n.container).append(t)}),o("#customify-upsell-tmpl").length&&o(o("#customify-upsell-tmpl").html()).insertAfter(o(".customify--cb-devices-switcher",n.container))},addItem:function(e){var i=this.getTemplate(),t="tmpl-customify--cb-item";if(0!=o("#"+t).length)return i=i(e,t),o(i)},addAvailableItems:function(){var c=this;_.each(c.devices,function(e,n){var a=o('<div class="customify-available-items" data-device="'+n+'"></div>');o(".customify--panel-"+n,c.container).append(a),_.each(c.items,function(e){var i,t=!0;_.isUndefined(e.devices)||_.isEmpty(e.devices)||(_.isString(e.devices)?e.devices!=n&&(t=!1):(i=!1,_.each(e.devices,function(e){n==e&&(i=!0)}),i||(t=!1))),t&&(t=c.addItem(e),a.append(t))})})},switchToDevice:function(e,i){var t=this;1<_.size(t.devices)?(o(".customify--cb-devices-switcher a",t.container).removeClass("customify--tab-active"),o(".customify--cb-devices-switcher .switch-to-"+e,t.container).addClass("customify--tab-active"),o(".customify--device-panel",t.container).addClass("customify--panel-hide"),o(".customify--device-panel.customify--panel-"+e,t.container).removeClass("customify--panel-hide"),t.activePanel=e):o(".customify--cb-devices-switcher a",t.container).addClass("customify--tab-active"),(_.isUndefined(i)||i)&&o("desktop"==e?"#customize-footer-actions .preview-desktop":"#customize-footer-actions .preview-mobile").trigger("click")},addNewWidget:function(e,i,t,n,a){e=this.container.find(".customify--device-panel.customify--panel-"+e),i=o(".customify--cb-row.customify--row-"+i,e),t=o(".col-items.col-"+t,i),i=o('.customify-available-items .grid-stack-item[data-id="'+n.id+'"]',e);t.append(i)},addExistingRowsItems:function(){var c=this,t=r.control(c.controlId).params.value;_.isObject(t)||(t={}),_.each(c.devices,function(e,a){var i={};_.isObject(t[a])&&(i=t[a]),_.each(i,function(e,n){_.isUndefined(e)||_.each(e,function(e,t){_.each(e,function(e,i){c.addNewWidget(a,n,t,e,i)})})})}),c.ready=!0},focus:function(){this.container.on("click",".customify--cb-item-setting, .customify--cb-item-name, .item-tooltip",function(e){e.preventDefault();var e=o(this).data("section")||"",i=o(this).attr("data-control")||"",t=!1;i&&!_.isUndefined(r.control(i))&&(r.control(i).focus(),t=!0),t||e&&!_.isUndefined(r.section(e))&&r.section(e).focus()}),this.container.on("click",".customify--cb-row-settings",function(e){e.preventDefault();e=o(this).attr("data-id")||"",e=c.id+"_"+e;_.isUndefined(r.section(e))||r.section(e).focus()})},remove:function(){var t=this;d.on("click",".customify--device-panel .customify--cb-item-remove",function(e){e.preventDefault();var e=o(this).closest(".grid-stack-item"),i=e.closest(".customify--device-panel");e.removeAttr("style"),o(".customify-available-items",i).append(e),t.save()})},encodeValue:function(e){return encodeURI(JSON.stringify(e))},decodeValue:function(e){return JSON.parse(decodeURI(e))},save:function(){var a,t=this;t.ready&&(a={},_.each(t.devices,function(e,n){a[n]={};var i=o(".customify--panel-"+n,t.container);o(".customify--cb-row",i).each(function(){var e=o(this),i=e.attr("data-row-id")||!1,t={};i&&(o(".col-items",e).each(function(){var e=o(this),i=e.attr("data-id")||!1;i&&(e=_.map(o(" > .grid-stack-item",e),function(e){return{id:(e=o(e)).data("id")||""}}),t[i]=e)}),a[n][i]=t)})}),r.control(t.controlId).setting.set(t.encodeValue(a)))},showPanel:function(){var e=this;this.container.removeClass("customify--builder--hide").addClass("customify--builder-show"),setTimeout(function(){e.container.height();o("#customize-preview").addClass("cb--preview-panel-show")},100)},hidePanel:function(){this.container.removeClass("customify--builder-show"),o("#customize-preview").removeClass("cb--preview-panel-show").removeAttr("style")},togglePanel:function(){var i=this;r.state("expandedPanel").bind(function(e){r.panel(c.panel).expanded()?(d.trigger("customify_panel_builder_open",[c.panel]),top._current_builder_panel=s,i.showPanel()):i.hidePanel()}),i.container.on("click",".customify--panel-close",function(e){e.preventDefault(),i.container.toggleClass("customify--builder--hide"),i.container.hasClass("customify--builder--hide")?o("#customize-preview").removeClass("cb--preview-panel-show"):o("#customize-preview").addClass("cb--preview-panel-show")})},panelLayoutCSS:function(){var e=o("#customize-controls").width();r.state("paneVisible").get()||(e=0),t?this.container.find(".customify--cb-inner").css({"margin-right":e}):this.container.find(".customify--cb-inner").css({"margin-left":e})},init:function(e,i,t){var n=this,a=n.getTemplate()(c,"tmpl-customify--builder-panel");n.container=o(a),n.container.addClass("customify--panel-v2"),o("body .wp-full-overlay").append(n.container),n.controlId=e,n.items=i,n.devices=t,c.section&&r.section(c.section).container.addClass("customify--hide"),n.addDevicePanels(),n.switchToDevice(n.activePanel),n.addAvailableItems(),n.switchToDevice(n.activePanel),n.drag_drop(),n.focus(),n.remove(),n.addExistingRowsItems(),r.panel(c.panel).expanded()?n.showPanel():n.hidePanel(),r.previewedDevice.bind(function(e){"desktop"===e?n.switchToDevice("desktop",!1):n.switchToDevice("mobile",!1)}),n.togglePanel(),r.state("paneVisible").get()&&n.panelLayoutCSS(),r.state("paneVisible").bind(function(){n.panelLayoutCSS()}),o(window).resize(_.throttle(function(){n.panelLayoutCSS()},100)),n.container.on("click",".customify--cb-devices-switcher a.switch-to",function(e){e.preventDefault();e=o(this).data("device");n.switchToDevice(e)}),d.trigger("customify_builder_panel_loaded",[s,n]),o(".grid-stack-item",n.container).addClass("no-tooltip").removeAttr("title")}},i=c.control_id;if(void 0!==c.versions){if(void 0===c.versions[e.version])return alert("Invaild settings"),!1;i=c.versions[e.version].control_id}return e.init(i,c.items,c.devices),e}}(jQuery);